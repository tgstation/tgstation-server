<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>tgstation-server: TGS.Server/Instance/Byond.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="tgs.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tgstation-server
   </div>
   <div id="projectbrief">The /tg/station 13 server suite</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d416ca425b5524beda4d68f02698bdb3.html">TGS.Server</a></li><li class="navelem"><a class="el" href="dir_247dc62efdba86a5141239c39fc82c17.html">Instance</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Byond.cs</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_t_g_s_8_server_2_instance_2_byond_8cs.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">using</span> <a class="code" href="_t_g_s_8_command_line_2_program_8cs.html#a81a223a02c34d82b47199f08308847f2">System</a>;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Collections.Generic;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.IO;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.IO.Compression;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Net;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Text.RegularExpressions;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Threading;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_t_g_s.html">TGS</a>.<a class="code" href="namespace_t_g_s_1_1_interface.html">Interface</a>;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_t_g_s.html">TGS</a>.<a class="code" href="namespace_t_g_s_1_1_interface.html">Interface</a>.<a class="code" href="namespace_t_g_s_1_1_interface_1_1_components.html">Components</a>;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_t_g_s.html">TGS</a>.<a class="code" href="class_t_g_s_1_1_interface_1_1_server.html">Server</a></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;{</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    sealed <span class="keyword">partial class </span><a class="code" href="class_t_g_s_1_1_interface_1_1_instance.html">Instance</a> : <a class="code" href="interface_t_g_s_1_1_interface_1_1_components_1_1_i_t_g_byond.html">ITGByond</a></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    {</div><div class="line"><a name="l00018"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a9efa4ea461f8ca8f1c1f10b59dc4bc66">   18</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> ByondDirectory = <span class="stringliteral">&quot;BYOND&quot;</span>;</div><div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a71a44e3a5d5b41aa8cdfca8d1007f916">   22</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> StagingDirectory = <span class="stringliteral">&quot;BYOND_staged&quot;</span>;</div><div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#aa9e071ffa09425b32638f7700f0e6998">   26</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> StagingDirectoryInner = StagingDirectory + <span class="stringliteral">&quot;/byond&quot;</span>;</div><div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a2ed6a913422799be709b9bc96079843a">   30</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> RevisionDownloadPath = <span class="stringliteral">&quot;BYONDRevision.zip&quot;</span>;</div><div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#ad58e7e902f1ae8301a067051c5b8479c">   34</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> VersionFile = <span class="stringliteral">&quot;/byond_version.dat&quot;</span>;</div><div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a25a9c5f417f672ee9b01b41f1bd9f114">   38</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> ByondRevisionsURL = <span class="stringliteral">&quot;https://secure.byond.com/download/build/{0}/{0}.{1}_byond.zip&quot;</span>;</div><div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#af60fa8ab17b53ba69e6969c87a121703">   42</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> ByondLatestURL = <span class="stringliteral">&quot;https://secure.byond.com/download/build/LATEST/&quot;</span>;</div><div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#acd58b7f32bd652601bf7adc38e5b5d1a">   46</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> ByondConfigDir = StagingDirectory + <span class="stringliteral">&quot;/BYOND/cfg&quot;</span>;</div><div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a2345519c680d34ee237e471cda72a7cc">   50</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> ByondDDConfig = ByondConfigDir + <span class="stringliteral">&quot;/daemon.txt&quot;</span>;</div><div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a16c7cb446fedd4bce134f62f21c572c2">   54</a></span>&#160;        <span class="keyword">const</span> <span class="keywordtype">string</span> ByondNoPromptTrustedMode = <span class="stringliteral">&quot;trusted-check 0&quot;</span>;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a6e43e2a1ac79154cf38602dbf3ae8f14">   59</a></span>&#160;        <span class="keyword">static</span> readonly <span class="keywordtype">string</span> ByondCacheDirectory = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), ByondDirectory, <span class="stringliteral">&quot;cache&quot;</span>);</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a08fd219037def4230946a2487815ef44">   64</a></span>&#160;        <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a> updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Idle;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#afa48afaed61100daacb9a97366281837">   69</a></span>&#160;        <span class="keywordtype">object</span> ByondLock = <span class="keyword">new</span> object();</div><div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a59a9f31f1b34f1c903b9f1af34e707e7">   73</a></span>&#160;        <span class="keywordtype">string</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a59a9f31f1b34f1c903b9f1af34e707e7">lastError</a>;</div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a05106e6dc12c2e62d28555ea51f7ce7b">   77</a></span>&#160;        Thread <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a05106e6dc12c2e62d28555ea51f7ce7b">RevisionStaging</a>;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a528e107d5b9f90f22ba68a4737e5f850">   82</a></span>&#160;        <span class="keywordtype">void</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a528e107d5b9f90f22ba68a4737e5f850">InitByond</a>()</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        {</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            CleanByondStaging();</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        }</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a159ebf40e20cc296bbb2bc2a0986a8ac">   90</a></span>&#160;        <span class="keywordtype">void</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a159ebf40e20cc296bbb2bc2a0986a8ac">CleanByondStaging</a>()</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        {</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;            var rrdp = RelativePath(RevisionDownloadPath);</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            <span class="comment">//linger not</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <span class="keywordflow">if</span> (File.Exists(rrdp))</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                File.Delete(rrdp);</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html">Helpers</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">DeleteDirectory</a>(RelativePath(StagingDirectory));</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        }</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#acf1139d8833360b4439c97cfba7fe117">  102</a></span>&#160;        <span class="keywordtype">void</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#acf1139d8833360b4439c97cfba7fe117">DisposeByond</a>()</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        {</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            lock (ByondLock)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            {</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                <span class="keywordflow">if</span> (RevisionStaging != null)</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                    RevisionStaging.Abort();</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                CleanByondStaging();</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            }</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        }</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        </div><div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a063758368f8d5aa77d82201c9f4e2808">  115</a></span>&#160;        <span class="keywordtype">void</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a063758368f8d5aa77d82201c9f4e2808">ClearCacheFolder</a>()</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        {</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                <a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html">Helpers</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">DeleteDirectory</a>(ByondCacheDirectory, <span class="keyword">true</span>, null);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            }</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            <span class="keywordflow">catch</span> { }</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#accd844ee6162c4270fec7671e706439c">  128</a></span>&#160;        <span class="keywordtype">bool</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#accd844ee6162c4270fec7671e706439c">BusyCheck</a>()</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        {</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            lock (ByondLock)</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                <span class="keywordflow">switch</span> (updateStat)</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                {</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Starting:</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Downloading:</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Staging:</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Updating:</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.CompilingStaged:</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Idle:</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Staged:</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                }</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        }</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#ab412ffc953f7e52aa48bf26a0fa5eaa4">  147</a></span>&#160;        <span class="keyword">public</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#ab412ffc953f7e52aa48bf26a0fa5eaa4">CurrentStatus</a>()</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        {</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            lock (ByondLock)</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            {</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                <span class="keywordflow">return</span> updateStat;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            }</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        }</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a6030958a6bb34345a20d70e190f75315">  156</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">string</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a6030958a6bb34345a20d70e190f75315">GetError</a>()</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        {</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            lock (ByondLock)</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                var error = lastError;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                lastError = null;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                <span class="keywordflow">return</span> error;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            }</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        }</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a277581d2109b82b7e94558007fb37595">  167</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">string</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a277581d2109b82b7e94558007fb37595">GetVersion</a>(<a class="code" href="namespace_t_g_s_1_1_interface.html#a1385bc6e3ab604932c185fe8bd6ad008">ByondVersion</a> type)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        {</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                {</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                    <span class="keywordflow">if</span> (type == <a class="code" href="namespace_t_g_s_1_1_interface.html#a1385bc6e3ab604932c185fe8bd6ad008">ByondVersion</a>.Latest)</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                    {</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                        <span class="comment">//get the latest version from the website</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                        HttpWebRequest request = (HttpWebRequest)WebRequest.Create(ByondLatestURL);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                        var results = <span class="keyword">new</span> List&lt;string&gt;();</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                        <span class="keyword">using</span> (HttpWebResponse response = (HttpWebResponse)request.GetResponse())</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                        {</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                            <span class="keyword">using</span> (StreamReader reader = <span class="keyword">new</span> StreamReader(response.GetResponseStream()))</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                            {</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                                <span class="keywordtype">string</span> html = reader.ReadToEnd();</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                                Regex regex = <span class="keyword">new</span> Regex(<span class="stringliteral">&quot;\\\&quot;([^\&quot;]*)\\\&quot;&quot;</span>);</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                                MatchCollection matches = regex.Matches(html);</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                                <span class="keywordflow">foreach</span> (Match match <span class="keywordflow">in</span> matches)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                                    <span class="keywordflow">if</span> (match.Success &amp;&amp; match.Value.Contains(<span class="stringliteral">&quot;_byond.exe&quot;</span>))</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                                        results.Add(match.Value.Replace(<span class="stringliteral">&quot;\&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>).Replace(<span class="stringliteral">&quot;_byond.exe&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                            }</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                        }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                        results.Sort();</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                        results.Reverse();</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                        <span class="keywordflow">return</span> results.Count &gt; 0 ? results[0] : null;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                    }</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                    {</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                        <span class="keywordtype">string</span> DirToUse = RelativePath(type == <a class="code" href="namespace_t_g_s_1_1_interface.html#a1385bc6e3ab604932c185fe8bd6ad008">ByondVersion</a>.Staged ? StagingDirectoryInner : ByondDirectory);</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                        <span class="keywordflow">if</span> (Directory.Exists(DirToUse))</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                        {</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                            <span class="keywordtype">string</span> file = DirToUse + VersionFile;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                            <span class="keywordflow">if</span> (File.Exists(file))</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                                <span class="keywordflow">return</span> File.ReadAllText(file);</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                        }</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                    }</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                    <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                }</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            }</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                <span class="keywordflow">return</span> <span class="stringliteral">&quot;Error: &quot;</span> + e.ToString();</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        }</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        </div><div class="line"><a name="l00218"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a833b631d726a8040002d3c83db7fdb8e">  218</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a833b631d726a8040002d3c83db7fdb8e">UpdateToVersionImpl</a>(<span class="keywordtype">object</span> param)</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        {</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            lock (ByondLock) { </div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                <span class="keywordflow">if</span> (updateStat != <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Starting)</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Downloading;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            }</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="keywordtype">bool</span> staged = <span class="keyword">false</span>;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            {</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                CleanByondStaging();</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                var vi = ((string)param).Split(<span class="charliteral">&#39;.&#39;</span>);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                var major = Convert.ToInt32(vi[0]);</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                var minor = Convert.ToInt32(vi[1]);</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                var rrdp = RelativePath(RevisionDownloadPath);</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                <span class="keyword">using</span> (var client = <span class="keyword">new</span> WebClient())</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                {</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                    SendMessage(String.Format(<span class="stringliteral">&quot;BYOND: Updating to version {0}.{1}...&quot;</span>, major, minor), <a class="code" href="namespace_t_g_s_1_1_server.html#ac244e362b52b9feac67ac6c2ca27f522">MessageType</a>.DeveloperInfo);</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                    <span class="comment">//DOWNLOADING</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                    <span class="keywordflow">try</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                    {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                        client.DownloadFile(String.Format(ByondRevisionsURL, major, minor), rrdp);</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                    }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                    <span class="keywordflow">catch</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                    {</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                        SendMessage(<span class="stringliteral">&quot;BYOND: Update download failed. Does the specified version exist?&quot;</span>, <a class="code" href="namespace_t_g_s_1_1_server.html#ac244e362b52b9feac67ac6c2ca27f522">MessageType</a>.DeveloperInfo);</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                        lastError = String.Format(<span class="stringliteral">&quot;Download of BYOND version {0}.{1} failed! Does it exist?&quot;</span>, major, minor);</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                        WriteWarning(String.Format(<span class="stringliteral">&quot;Failed to update BYOND to version {0}.{1}!&quot;</span>, major, minor), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.BYONDUpdateFail);</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                        lock (ByondLock)</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                        {</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                            updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Idle;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                        }</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                    }</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                }</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                {</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Staging;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                }</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                <span class="comment">//STAGING</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                </div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                ZipFile.ExtractToDirectory(rrdp, RelativePath(StagingDirectory));</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                    File.WriteAllText(RelativePath(StagingDirectoryInner + VersionFile), String.Format(<span class="stringliteral">&quot;{0}.{1}&quot;</span>, major, minor));</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                    <span class="comment">//IMPORTANT: SET THE BYOND CONFIG TO NOT PROMPT FOR TRUSTED MODE REEE</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                    Directory.CreateDirectory(RelativePath(ByondConfigDir));</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                    File.WriteAllText(RelativePath(ByondDDConfig), ByondNoPromptTrustedMode);</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                }</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                File.Delete(RevisionDownloadPath);</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                {</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Staged;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                }</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                <span class="keywordflow">switch</span> (DaemonStatus())</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                {</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="namespace_t_g_s_1_1_interface.html#a769cbe24216f6ab7cb0cdf2b39177175">DreamDaemonStatus</a>.Offline:</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                        <span class="keywordflow">if</span>(ApplyStagedUpdate())</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                            lastError = null;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                        <span class="keywordflow">else</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                            lastError = <span class="stringliteral">&quot;Failed to apply update!&quot;</span>;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                        <span class="comment">//Compile() will call RequestRestart()</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                        lastError = <span class="stringliteral">&quot;Update staged. Awaiting server restart...&quot;</span>;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                        SendMessage(String.Format(<span class="stringliteral">&quot;BYOND: Staging complete. Awaiting server restart...&quot;</span>, major, minor), <a class="code" href="namespace_t_g_s_1_1_server.html#ac244e362b52b9feac67ac6c2ca27f522">MessageType</a>.DeveloperInfo);</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                        WriteInfo(String.Format(<span class="stringliteral">&quot;BYOND update {0}.{1} staged&quot;</span>, major, minor), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.BYONDUpdateStaged);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                        staged = <span class="keyword">true</span>;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                }</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            }</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <span class="keywordflow">catch</span> (ThreadAbortException)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            {</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            }</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            {</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                WriteError(<span class="stringliteral">&quot;Revision staging errror: &quot;</span> + e.ToString(), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.BYONDUpdateFail);</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Idle;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                    lastError = e.ToString();</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                    RevisionStaging = null;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                }</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            }</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            <span class="keywordflow">if</span> (staged)</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                    <span class="comment">//Some fuckery to trick the compiler into starting even though we&#39;re staged</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                    <span class="comment">//Won&#39;t fuck up the actual compiler thread though</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Idle;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    Compile();</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Staged;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                }</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        }</div><div class="line"><a name="l00320"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a985e225708d6d6fbcc4f59ef443d63cf">  320</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a985e225708d6d6fbcc4f59ef443d63cf">UpdateToVersion</a>(<span class="keywordtype">int</span> major, <span class="keywordtype">int</span> minor)</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        {</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            lock (ByondLock)</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            {</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                <span class="keywordflow">if</span> (!BusyCheck())</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                {</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Starting;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                    RevisionStaging = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ParameterizedThreadStart(UpdateToVersionImpl))</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                    {</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                        IsBackground = <span class="keyword">true</span> <span class="comment">//don&#39;t slow me down</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                    };</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                    RevisionStaging.Start(String.Format(<span class="stringliteral">&quot;{0}.{1}&quot;</span>, major, minor));</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                }</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>; </div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            }</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        }</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#ac318b9e316c87b79912f3e6551f1ec3e">  342</a></span>&#160;        <span class="keywordtype">bool</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#ac318b9e316c87b79912f3e6551f1ec3e">ApplyStagedUpdate</a>()</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        {</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            lock (CompilerLock)</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            {</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                <span class="keywordflow">if</span> (compilerCurrentStatus == <a class="code" href="namespace_t_g_s_1_1_interface.html#a4270720d0fdafb1bce877eda81e65c1c">CompilerStatus</a>.Compiling)</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                lock (ByondLock)</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                {</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                    <span class="keywordflow">if</span> (updateStat != <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Staged)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                    updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Updating;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                }</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                <span class="keywordflow">try</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                {</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    var rbd = RelativePath(ByondDirectory);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    <a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html">Helpers</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">DeleteDirectory</a>(rbd);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    Directory.Move(RelativePath(StagingDirectoryInner), rbd);</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                    <a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html">Helpers</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">DeleteDirectory</a>(RelativePath(StagingDirectory));</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    lastError = null;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    SendMessage(<span class="stringliteral">&quot;BYOND: Update completed!&quot;</span>, <a class="code" href="namespace_t_g_s_1_1_server.html#ac244e362b52b9feac67ac6c2ca27f522">MessageType</a>.DeveloperInfo);</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                    WriteInfo(String.Format(<span class="stringliteral">&quot;BYOND update {0} completed!&quot;</span>, GetVersion(<a class="code" href="namespace_t_g_s_1_1_interface.html#a1385bc6e3ab604932c185fe8bd6ad008">ByondVersion</a>.Installed)), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.BYONDUpdateComplete);</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                }</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                {</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    lastError = e.ToString();</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                    SendMessage(<span class="stringliteral">&quot;BYOND: Update failed!&quot;</span>, <a class="code" href="namespace_t_g_s_1_1_server.html#ac244e362b52b9feac67ac6c2ca27f522">MessageType</a>.DeveloperInfo);</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                    WriteError(<span class="stringliteral">&quot;BYOND update failed! Error: &quot;</span> + e.ToString(), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.BYONDUpdateFail);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                }</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                <span class="keywordflow">finally</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                {</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                    lock(ByondLock) {</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                        updateStat = <a class="code" href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">ByondStatus</a>.Idle;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    }</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                }</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;            }</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        }</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    }</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;}</div><div class="ttc" id="class_t_g_s_1_1_interface_1_1_server_html"><div class="ttname"><a href="class_t_g_s_1_1_interface_1_1_server.html">TGS.Interface.Server</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_interface_2_server_8cs_source.html#l00008">Server.cs:8</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_html_a1385bc6e3ab604932c185fe8bd6ad008"><div class="ttname"><a href="namespace_t_g_s_1_1_interface.html#a1385bc6e3ab604932c185fe8bd6ad008">TGS.Interface.ByondVersion</a></div><div class="ttdeci">ByondVersion</div><div class="ttdoc">Type of byond version </div><div class="ttdef"><b>Definition:</b> <a href="_enumerations_8cs_source.html#l00066">Enumerations.cs:66</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_html"><div class="ttname"><a href="namespace_t_g_s_1_1_interface.html">TGS.Interface</a></div><div class="ttdef"><b>Definition:</b> <a href="_authentication_header_applicator_8cs_source.html#l00009">AuthenticationHeaderApplicator.cs:9</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_ab412ffc953f7e52aa48bf26a0fa5eaa4"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#ab412ffc953f7e52aa48bf26a0fa5eaa4">TGS.Server.Instance.CurrentStatus</a></div><div class="ttdeci">ByondStatus CurrentStatus()</div><div class="ttdoc">Gets the current status of any BYOND updates  </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00147">Byond.cs:147</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_ac318b9e316c87b79912f3e6551f1ec3e"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#ac318b9e316c87b79912f3e6551f1ec3e">TGS.Server.Instance.ApplyStagedUpdate</a></div><div class="ttdeci">bool ApplyStagedUpdate()</div><div class="ttdoc">Attempts to move the staged update from StagingDirectory to ByondDirectory. Sets lastError on failure...</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00342">Byond.cs:342</a></div></div>
<div class="ttc" id="namespace_system_html"><div class="ttname"><a href="namespace_system.html">System</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a528e107d5b9f90f22ba68a4737e5f850"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a528e107d5b9f90f22ba68a4737e5f850">TGS.Server.Instance.InitByond</a></div><div class="ttdeci">void InitByond()</div><div class="ttdoc">Called when the Instance is setup. Prepares the BYOND updater </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00082">Byond.cs:82</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a063758368f8d5aa77d82201c9f4e2808"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a063758368f8d5aa77d82201c9f4e2808">TGS.Server.Instance.ClearCacheFolder</a></div><div class="ttdeci">void ClearCacheFolder()</div><div class="ttdoc">Attempts to clear the ByondCacheDirectory </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00115">Byond.cs:115</a></div></div>
<div class="ttc" id="interface_t_g_s_1_1_interface_1_1_components_1_1_i_t_g_byond_html"><div class="ttname"><a href="interface_t_g_s_1_1_interface_1_1_components_1_1_i_t_g_byond.html">TGS.Interface.Components.ITGByond</a></div><div class="ttdoc">For managing the BYOND installation the server runs </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_interface_2_components_2_byond_8cs_source.html#l00010">Byond.cs:10</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a277581d2109b82b7e94558007fb37595"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a277581d2109b82b7e94558007fb37595">TGS.Server.Instance.GetVersion</a></div><div class="ttdeci">string GetVersion(ByondVersion type)</div><div class="ttdoc">Get the currently installed version as a string formatted as Major.Minor  </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00167">Byond.cs:167</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_interface_1_1_instance_html"><div class="ttname"><a href="class_t_g_s_1_1_interface_1_1_instance.html">TGS.Interface.Instance</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_interface_2_instance_8cs_source.html#l00008">Instance.cs:8</a></div></div>
<div class="ttc" id="namespace_t_g_s_html"><div class="ttname"><a href="namespace_t_g_s.html">TGS</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_html_a4b94c11ccb4064514452be149335bcb0"><div class="ttname"><a href="namespace_t_g_s_1_1_interface.html#a4b94c11ccb4064514452be149335bcb0">TGS.Interface.ByondStatus</a></div><div class="ttdeci">ByondStatus</div><div class="ttdoc">The status of a BYOND update job </div><div class="ttdef"><b>Definition:</b> <a href="_enumerations_8cs_source.html#l00032">Enumerations.cs:32</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_helpers_html_a5b1d1510ab671f24b98ecafa79f98c00"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">TGS.Server.Helpers.DeleteDirectory</a></div><div class="ttdeci">static void DeleteDirectory(string path, bool ContentsOnly=false, IList&lt; string &gt; excludeRoot=null)</div><div class="ttdoc">Recursive directory deleter </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_helpers_8cs_source.html#l00037">Helpers.cs:37</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_html_a769cbe24216f6ab7cb0cdf2b39177175"><div class="ttname"><a href="namespace_t_g_s_1_1_interface.html#a769cbe24216f6ab7cb0cdf2b39177175">TGS.Interface.DreamDaemonStatus</a></div><div class="ttdeci">DreamDaemonStatus</div><div class="ttdoc">The status of the DD instance </div><div class="ttdef"><b>Definition:</b> <a href="_enumerations_8cs_source.html#l00144">Enumerations.cs:144</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a05106e6dc12c2e62d28555ea51f7ce7b"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a05106e6dc12c2e62d28555ea51f7ce7b">TGS.Server.Instance.RevisionStaging</a></div><div class="ttdeci">Thread RevisionStaging</div><div class="ttdoc">Thread used for staging BYOND revisions </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00077">Byond.cs:77</a></div></div>
<div class="ttc" id="_t_g_s_8_command_line_2_program_8cs_html_a81a223a02c34d82b47199f08308847f2"><div class="ttname"><a href="_t_g_s_8_command_line_2_program_8cs.html#a81a223a02c34d82b47199f08308847f2">System</a></div><div class="ttdeci">using System</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_command_line_2_program_8cs_source.html#l00001">Program.cs:1</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_html_a4270720d0fdafb1bce877eda81e65c1c"><div class="ttname"><a href="namespace_t_g_s_1_1_interface.html#a4270720d0fdafb1bce877eda81e65c1c">TGS.Interface.CompilerStatus</a></div><div class="ttdeci">CompilerStatus</div><div class="ttdoc">The status of the compiler </div><div class="ttdef"><b>Definition:</b> <a href="_enumerations_8cs_source.html#l00121">Enumerations.cs:121</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_server_html_a4682739b9567dc9e4e5c327c253ce311"><div class="ttname"><a href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">TGS.Server.EventID</a></div><div class="ttdeci">EventID</div><div class="ttdoc">Various events and their IDs in no particular order. Found in the Windows event log. These key incremented by 100 and are guaranteed to never be reused in the future. In the windows event viewer, these IDs will be offset by the Instance.LoggingID to distinguish events between instances. Each event ID may be information, a warning, or error and will be documented accordingly. Warnings will occur due to user, data, or network errors. Errors will occur due to filesystem errors or hard faults </div><div class="ttdef"><b>Definition:</b> <a href="_event_i_d_8cs_source.html#l00008">EventID.cs:8</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_helpers_html"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_helpers.html">TGS.Server.Helpers</a></div><div class="ttdoc">Generic helpers for the Server </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_helpers_8cs_source.html#l00012">Helpers.cs:12</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a59a9f31f1b34f1c903b9f1af34e707e7"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a59a9f31f1b34f1c903b9f1af34e707e7">TGS.Server.Instance.lastError</a></div><div class="ttdeci">string lastError</div><div class="ttdoc">The last error the BYOND updater encountered </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00073">Byond.cs:73</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_acf1139d8833360b4439c97cfba7fe117"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#acf1139d8833360b4439c97cfba7fe117">TGS.Server.Instance.DisposeByond</a></div><div class="ttdeci">void DisposeByond()</div><div class="ttdoc">Called when the Instance is shutdown </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00102">Byond.cs:102</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_server_html_ac244e362b52b9feac67ac6c2ca27f522"><div class="ttname"><a href="namespace_t_g_s_1_1_server.html#ac244e362b52b9feac67ac6c2ca27f522">TGS.Server.MessageType</a></div><div class="ttdeci">MessageType</div><div class="ttdoc">Type of chat message, these may be OR&amp;#39;d together </div><div class="ttdef"><b>Definition:</b> <a href="_message_type_8cs_source.html#l00008">MessageType.cs:8</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a833b631d726a8040002d3c83db7fdb8e"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a833b631d726a8040002d3c83db7fdb8e">TGS.Server.Instance.UpdateToVersionImpl</a></div><div class="ttdeci">void UpdateToVersionImpl(object param)</div><div class="ttdoc">Downloads and unzips a BYOND revision. Calls ApplyStagedUpdate afterwards if the Instance isn&amp;#39;t runni...</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00218">Byond.cs:218</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a6030958a6bb34345a20d70e190f75315"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a6030958a6bb34345a20d70e190f75315">TGS.Server.Instance.GetError</a></div><div class="ttdeci">string GetError()</div><div class="ttdoc">Check the last update error. Checking this will clear the value  </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00156">Byond.cs:156</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a159ebf40e20cc296bbb2bc2a0986a8ac"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a159ebf40e20cc296bbb2bc2a0986a8ac">TGS.Server.Instance.CleanByondStaging</a></div><div class="ttdeci">void CleanByondStaging()</div><div class="ttdoc">Cleans the BYOND staging directory </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00090">Byond.cs:90</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_accd844ee6162c4270fec7671e706439c"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#accd844ee6162c4270fec7671e706439c">TGS.Server.Instance.BusyCheck</a></div><div class="ttdeci">bool BusyCheck()</div><div class="ttdoc">Checks if the updater is considered busy </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00128">Byond.cs:128</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_1_1_components_html"><div class="ttname"><a href="namespace_t_g_s_1_1_interface_1_1_components.html">TGS.Interface.Components</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_interface_2_components_2_administration_8cs_source.html#l00003">Administration.cs:3</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a985e225708d6d6fbcc4f59ef443d63cf"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a985e225708d6d6fbcc4f59ef443d63cf">TGS.Server.Instance.UpdateToVersion</a></div><div class="ttdeci">bool UpdateToVersion(int major, int minor)</div><div class="ttdoc">updates the used byond version to that of version major .minor . The change won&amp;#39;t take place until DD...</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_byond_8cs_source.html#l00320">Byond.cs:320</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
