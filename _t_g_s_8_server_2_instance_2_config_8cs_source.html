<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>tgstation-server: TGS.Server/Instance/Config.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="tgs.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tgstation-server
   </div>
   <div id="projectbrief">The /tg/station 13 server suite</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d416ca425b5524beda4d68f02698bdb3.html">TGS.Server</a></li><li class="navelem"><a class="el" href="dir_247dc62efdba86a5141239c39fc82c17.html">Instance</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Config.cs</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_t_g_s_8_server_2_instance_2_config_8cs.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">using</span> <a class="code" href="_t_g_s_8_command_line_2_program_8cs.html#a81a223a02c34d82b47199f08308847f2">System</a>;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Collections.Generic;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.IO;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.ServiceModel;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_t_g_s.html">TGS</a>.<a class="code" href="namespace_t_g_s_1_1_interface.html">Interface</a>.<a class="code" href="namespace_t_g_s_1_1_interface_1_1_components.html">Components</a>;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_t_g_s.html">TGS</a>.Server</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;{</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="comment">//knobs and such</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    sealed <span class="keyword">partial class </span>Instance : <a class="code" href="interface_t_g_s_1_1_interface_1_1_components_1_1_i_t_g_config.html">ITGConfig</a></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    {</div><div class="line"><a name="l00015"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a08ee3406d0c5af9270d61039012ca463">   15</a></span>&#160;        <span class="keywordtype">object</span> configLock = <span class="keyword">new</span> object();   <span class="comment">//for atomic reads/writes</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a07f764eec98c909d04b62caf2b748238">   18</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">string</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a07f764eec98c909d04b62caf2b748238">ReadText</a>(<span class="keywordtype">string</span> staticRelativePath, <span class="keywordtype">bool</span> repo, out <span class="keywordtype">string</span> error, out <span class="keywordtype">bool</span> unauthorized)</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        {</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;            <span class="keywordtype">string</span> path = null;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;            {</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;                var configDir = RelativePath(repo ? RepoPath : StaticDirs);</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;                path = configDir + <span class="charliteral">&#39;/&#39;</span> + staticRelativePath;   <span class="comment">//do not use path.combine or it will try and take the root</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;                lock (configLock)</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;                {</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;                    var di1 = <span class="keyword">new</span> DirectoryInfo(configDir);</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;                    <span class="keywordflow">if</span> (repo)</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;                    {</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;                        <span class="comment">//ensure we aren&#39;t trying to read anything outside the static dirs</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;                        var Config = GetCachedRepoConfig();</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;                        <span class="keywordflow">if</span> (Config == null)</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;                        {</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;                            error = <span class="stringliteral">&quot;Unable to load static directory configuration&quot;</span>;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;                            unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;                            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;                        }</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;                        var Found = <span class="keyword">false</span>;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;                        <span class="keywordflow">foreach</span> (var I <span class="keywordflow">in</span> Config.StaticDirectoryPaths)</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;                        {</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;                            <span class="keywordflow">if</span> (di1.FullName == <span class="keyword">new</span> DirectoryInfo(Path.Combine(RelativePath(RepoPath), I)).FullName)</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;                            {</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;                                Found = <span class="keyword">true</span>;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                                <span class="keywordflow">break</span>;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                            }</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                        }</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                        <span class="keywordflow">if</span> (!Found)</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                        {</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;                            error = <span class="stringliteral">&quot;File is not in a configured static directory!&quot;</span>;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                            unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                        }</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;                    }</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                    var di2 = <span class="keyword">new</span> DirectoryInfo(<span class="keyword">new</span> FileInfo(path).Directory.FullName);</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;                    var good = <span class="keyword">false</span>;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                    <span class="keywordflow">while</span> (di2 != null)</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                    {</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                        <span class="keywordflow">if</span> (di2.FullName == di1.FullName)</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                        {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                            good = <span class="keyword">true</span>;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                        }</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                        <span class="keywordflow">else</span> di2 = di2.Parent;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                    }</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                    <span class="keywordflow">if</span> (!good)</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                    {</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                        error = <span class="stringliteral">&quot;Cannot read above static directories!&quot;</span>;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                        unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;                        <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                    }</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                    <span class="keywordtype">string</span> output;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                    <span class="keyword">using</span> (<a class="code" href="class_t_g_s_1_1_server_1_1_server.html">Server</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_server.html#abc583e331c2692b47d83a4af67ddb5b4">BeginImpersonation</a>())</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                        output = File.ReadAllText(path);</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                    WriteInfo(<span class="stringliteral">&quot;Read of &quot;</span> + path, <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.StaticRead);</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                    error = null;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                    unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                    <span class="keywordflow">return</span> output;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                }</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            }</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <span class="keywordflow">catch</span> (UnauthorizedAccessException e)</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            {</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                <span class="comment">//no need for the full stacktrace</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                error = e.Message;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                unauthorized = <span class="keyword">true</span>;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            }</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;            <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            {</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                error = e.ToString();</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                WriteWarning(String.Format(<span class="stringliteral">&quot;Read of {0} failed! Error: {1}&quot;</span>, path, e.ToString()), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.StaticRead);</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            }</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        }</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#ab3654af3cdaf2d738ad590e8ea009782">  102</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">string</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#ab3654af3cdaf2d738ad590e8ea009782">WriteText</a>(<span class="keywordtype">string</span> staticRelativePath, <span class="keywordtype">string</span> data, out <span class="keywordtype">bool</span> unauthorized)</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        {</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            var path = RelativePath(StaticDirs) + <span class="charliteral">&#39;/&#39;</span> + staticRelativePath;   <span class="comment">//do not use path.combine or it will try and take the root</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            {</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                lock (configLock)</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                {</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                    var di1 = <span class="keyword">new</span> DirectoryInfo(RelativePath(StaticDirs));</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                    var destdir = <span class="keyword">new</span> FileInfo(path).Directory.FullName;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                    var di2 = <span class="keyword">new</span> DirectoryInfo(destdir);</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                    var good = <span class="keyword">false</span>;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                    <span class="keywordflow">while</span> (di2 != null)</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                    {</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                        <span class="keywordflow">if</span> (di2.FullName == di1.FullName)</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                        {</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                            good = <span class="keyword">true</span>;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                        }</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                        <span class="keywordflow">else</span> di2 = di2.Parent;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                    }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                    <span class="keywordflow">if</span> (!good)</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                    {</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                        unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Cannot write above static directories!&quot;</span>;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                    }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                    <span class="keyword">using</span> (<a class="code" href="class_t_g_s_1_1_server_1_1_server.html">Server</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_server.html#abc583e331c2692b47d83a4af67ddb5b4">BeginImpersonation</a>())</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                    {</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                        Directory.CreateDirectory(destdir);</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                        File.WriteAllText(path, data);</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                    }</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                    WriteInfo(<span class="stringliteral">&quot;Write to &quot;</span> + path, <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.StaticWrite);</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                    unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                    <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                }</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            }</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;            <span class="keywordflow">catch</span> (UnauthorizedAccessException e)</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            {</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                <span class="comment">//no need for the full stacktrace</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                unauthorized = <span class="keyword">true</span>;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                <span class="keywordflow">return</span> e.Message;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            }</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                WriteWarning(String.Format(<span class="stringliteral">&quot;Write of {0} failed! Error: {1}&quot;</span>, path, e.ToString()), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.StaticRead);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                <span class="keywordflow">return</span> e.ToString();</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            }</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        }</div><div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a232046a10167c8b30bedf068284c2857">  154</a></span>&#160;        <span class="keyword">public</span> <span class="keywordtype">string</span> <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a232046a10167c8b30bedf068284c2857">DeleteFile</a>(<span class="keywordtype">string</span> staticRelativePath, out <span class="keywordtype">bool</span> unauthorized)</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        {</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            var path = RelativePath(StaticDirs + <span class="charliteral">&#39;/&#39;</span> + staticRelativePath);   <span class="comment">//do not use path.combine or it will try and take the root</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            {</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                lock (configLock)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                {</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                    var di1 = <span class="keyword">new</span> DirectoryInfo(RelativePath(StaticDirs));</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                    var fi = <span class="keyword">new</span> FileInfo(path);</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                    var di2 = <span class="keyword">new</span> DirectoryInfo(fi.Directory.FullName);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                    var good = <span class="keyword">false</span>;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                    <span class="keywordflow">while</span> (di2 != null)</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                    {</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                        <span class="keywordflow">if</span> (di2.FullName == di1.FullName)</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                        {</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                            good = <span class="keyword">true</span>;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                        }</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                        <span class="keywordflow">else</span> di2 = di2.Parent;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                    }</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                    <span class="keywordflow">if</span> (!good)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                    {</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                        unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Cannot delete above static directories!&quot;</span>;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                    }</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                    <span class="keyword">using</span> (<a class="code" href="class_t_g_s_1_1_server_1_1_server.html">Server</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_server.html#abc583e331c2692b47d83a4af67ddb5b4">BeginImpersonation</a>())</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                        <span class="keywordflow">if</span> (fi.Exists)</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                            File.Delete(path);</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Directory.Exists(path))</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                            <a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html">Helpers</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">DeleteDirectory</a>(path);</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                    WriteInfo(<span class="stringliteral">&quot;Delete of &quot;</span> + path, <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.StaticDelete);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                    unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                    <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            }</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="keywordflow">catch</span> (UnauthorizedAccessException e)</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            {</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                <span class="comment">//no need for the full stacktrace</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                unauthorized = <span class="keyword">true</span>;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                <span class="keywordflow">return</span> e.Message;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            }</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            {</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                WriteWarning(String.Format(<span class="stringliteral">&quot;Delete of {0} failed! Error: {1}&quot;</span>, path, e.ToString()), <a class="code" href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">EventID</a>.StaticRead);</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                <span class="keywordflow">return</span> e.ToString();</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            }</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        }</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno"><a class="line" href="class_t_g_s_1_1_server_1_1_instance.html#a6f9c9d3a1d79a12c8cdfabbb9f1fae4a">  207</a></span>&#160;        <span class="keyword">public</span> IList&lt;string&gt; <a class="code" href="class_t_g_s_1_1_server_1_1_instance.html#a6f9c9d3a1d79a12c8cdfabbb9f1fae4a">ListStaticDirectory</a>(<span class="keywordtype">string</span> subDir, out <span class="keywordtype">string</span> error, out <span class="keywordtype">bool</span> unauthorized)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        {</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="keywordflow">try</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            {</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                <span class="keywordflow">if</span> (!Directory.Exists(RelativePath(StaticDirs)))</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                    error = null;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                    unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">new</span> List&lt;string&gt;();</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                }</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                <span class="keyword">using</span> (<a class="code" href="class_t_g_s_1_1_server_1_1_server.html">Server</a>.<a class="code" href="class_t_g_s_1_1_server_1_1_server.html#abc583e331c2692b47d83a4af67ddb5b4">BeginImpersonation</a>())</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                {</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                    DirectoryInfo dirToEnum = <span class="keyword">new</span> DirectoryInfo(RelativePath(StaticDirs) + <span class="charliteral">&#39;/&#39;</span> + subDir ?? <span class="stringliteral">&quot;&quot;</span>); <span class="comment">//do not use path.combine or it will try and take the root</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                    var result = <span class="keyword">new</span> List&lt;string&gt;();</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                    <span class="keywordflow">foreach</span> (var I <span class="keywordflow">in</span> dirToEnum.GetFiles())</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                        result.Add(I.Name);</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                    <span class="keywordflow">foreach</span> (var I <span class="keywordflow">in</span> dirToEnum.GetDirectories())</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                        result.Add(<span class="charliteral">&#39;/&#39;</span> + I.Name);</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                    error = null;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                    unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                    <span class="keywordflow">return</span> result;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                }</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            }</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="keywordflow">catch</span> (UnauthorizedAccessException e)</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            {</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                <span class="comment">//no need for the full stacktrace</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                error = e.Message;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                unauthorized = <span class="keyword">true</span>;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            }</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            <span class="keywordflow">catch</span> (Exception e)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            {</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                error = e.ToString();</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                unauthorized = <span class="keyword">false</span>;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            }</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    }</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;}</div><div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a07f764eec98c909d04b62caf2b748238"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a07f764eec98c909d04b62caf2b748238">TGS.Server.Instance.ReadText</a></div><div class="ttdeci">string ReadText(string staticRelativePath, bool repo, out string error, out bool unauthorized)</div><div class="ttdoc">Read from a static file  </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_config_8cs_source.html#l00018">Config.cs:18</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a6f9c9d3a1d79a12c8cdfabbb9f1fae4a"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a6f9c9d3a1d79a12c8cdfabbb9f1fae4a">TGS.Server.Instance.ListStaticDirectory</a></div><div class="ttdeci">IList&lt; string &gt; ListStaticDirectory(string subDir, out string error, out bool unauthorized)</div><div class="ttdoc">Returns the file contents of the specified server directory Subdirectories will be prefixed with &amp;#39;/&amp;#39; ...</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_config_8cs_source.html#l00207">Config.cs:207</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_html"><div class="ttname"><a href="namespace_t_g_s_1_1_interface.html">TGS.Interface</a></div><div class="ttdef"><b>Definition:</b> <a href="_authentication_header_applicator_8cs_source.html#l00009">AuthenticationHeaderApplicator.cs:9</a></div></div>
<div class="ttc" id="namespace_system_html"><div class="ttname"><a href="namespace_system.html">System</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_a232046a10167c8b30bedf068284c2857"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#a232046a10167c8b30bedf068284c2857">TGS.Server.Instance.DeleteFile</a></div><div class="ttdeci">string DeleteFile(string staticRelativePath, out bool unauthorized)</div><div class="ttdoc">Deletes the target static file  </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_config_8cs_source.html#l00154">Config.cs:154</a></div></div>
<div class="ttc" id="namespace_t_g_s_html"><div class="ttname"><a href="namespace_t_g_s.html">TGS</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_server_html_abc583e331c2692b47d83a4af67ddb5b4"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_server.html#abc583e331c2692b47d83a4af67ddb5b4">TGS.Server.Server.BeginImpersonation</a></div><div class="ttdeci">static WindowsImpersonationContext BeginImpersonation()</div><div class="ttdoc">Begins user impersonation to allow proper restricted file access </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_server_8cs_source.html#l00053">Server.cs:53</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_helpers_html_a5b1d1510ab671f24b98ecafa79f98c00"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_helpers.html#a5b1d1510ab671f24b98ecafa79f98c00">TGS.Server.Helpers.DeleteDirectory</a></div><div class="ttdeci">static void DeleteDirectory(string path, bool ContentsOnly=false, IList&lt; string &gt; excludeRoot=null)</div><div class="ttdoc">Recursive directory deleter </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_helpers_8cs_source.html#l00038">Helpers.cs:38</a></div></div>
<div class="ttc" id="interface_t_g_s_1_1_interface_1_1_components_1_1_i_t_g_config_html"><div class="ttname"><a href="interface_t_g_s_1_1_interface_1_1_components_1_1_i_t_g_config.html">TGS.Interface.Components.ITGConfig</a></div><div class="ttdoc">For modifying the in game config Most if not all of these will not apply until the next server reboot...</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_interface_2_components_2_config_8cs_source.html#l00011">Config.cs:11</a></div></div>
<div class="ttc" id="_t_g_s_8_command_line_2_program_8cs_html_a81a223a02c34d82b47199f08308847f2"><div class="ttname"><a href="_t_g_s_8_command_line_2_program_8cs.html#a81a223a02c34d82b47199f08308847f2">System</a></div><div class="ttdeci">ï»¿using System</div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_command_line_2_program_8cs_source.html#l00001">Program.cs:1</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_instance_html_ab3654af3cdaf2d738ad590e8ea009782"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_instance.html#ab3654af3cdaf2d738ad590e8ea009782">TGS.Server.Instance.WriteText</a></div><div class="ttdeci">string WriteText(string staticRelativePath, string data, out bool unauthorized)</div><div class="ttdoc">Write to a static file  </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_instance_2_config_8cs_source.html#l00102">Config.cs:102</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_server_html_a4682739b9567dc9e4e5c327c253ce311"><div class="ttname"><a href="namespace_t_g_s_1_1_server.html#a4682739b9567dc9e4e5c327c253ce311">TGS.Server.EventID</a></div><div class="ttdeci">EventID</div><div class="ttdoc">Various events and their IDs in no particular order. Found in the Windows event log. These key incremented by 100 and are guaranteed to never be reused in the future. In the windows event viewer, these IDs will be offset by the Instance.LoggingID to distinguish events between instances. Each event ID may be information, a warning, or error and will be documented accordingly. Warnings will occur due to user, data, or network errors. Errors will occur due to filesystem errors or hard faults </div><div class="ttdef"><b>Definition:</b> <a href="_event_i_d_8cs_source.html#l00008">EventID.cs:8</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_helpers_html"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_helpers.html">TGS.Server.Helpers</a></div><div class="ttdoc">Generic helpers for the Server </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_helpers_8cs_source.html#l00013">Helpers.cs:13</a></div></div>
<div class="ttc" id="class_t_g_s_1_1_server_1_1_server_html"><div class="ttname"><a href="class_t_g_s_1_1_server_1_1_server.html">TGS.Server.Server</a></div><div class="ttdoc">The windows service the application runs as </div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_server_2_server_8cs_source.html#l00017">Server.cs:17</a></div></div>
<div class="ttc" id="namespace_t_g_s_1_1_interface_1_1_components_html"><div class="ttname"><a href="namespace_t_g_s_1_1_interface_1_1_components.html">TGS.Interface.Components</a></div><div class="ttdef"><b>Definition:</b> <a href="_t_g_s_8_interface_2_components_2_administration_8cs_source.html#l00003">Administration.cs:3</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
